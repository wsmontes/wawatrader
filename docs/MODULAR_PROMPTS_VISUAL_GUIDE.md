# Modular Prompt Architecture - Visual Guide

## ğŸ¨ System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TRADING AGENT                              â”‚
â”‚  "I need to know: Should I sell AAPL?"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QUERY CONTEXT                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ query_type = 'POSITION_REVIEW'                           â”‚  â”‚
â”‚  â”‚ trigger = 'CAPITAL_CONSTRAINT'                           â”‚  â”‚
â”‚  â”‚ profile = 'rotator'                                      â”‚  â”‚
â”‚  â”‚ primary_symbol = 'AAPL'                                  â”‚  â”‚
â”‚  â”‚ expected_format = 'STANDARD_DECISION'                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PROMPT BUILDER                                â”‚
â”‚  "Let me select the right components..."                        â”‚
â”‚                                                                  â”‚
â”‚  Component Selection Logic:                                     â”‚
â”‚  â”œâ”€ ALWAYS: QueryType, Trigger, Profile, Task, Format          â”‚
â”‚  â”œâ”€ IF position review: Add PositionData                        â”‚
â”‚  â”œâ”€ IF technical analysis: Add TechnicalData                    â”‚
â”‚  â””â”€ IF capital constraint: Add PortfolioSummary                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               SELECTED COMPONENTS                               â”‚
â”‚  (Priority: High â†’ Low)                                         â”‚
â”‚                                                                  â”‚
â”‚  [10] QueryTypeComponent('POSITION_REVIEW')                     â”‚
â”‚  [ 9] TriggerComponent('CAPITAL_CONSTRAINT')                    â”‚
â”‚  [ 9] TradingProfileComponent('rotator')                        â”‚
â”‚  [ 8] PositionDataComponent({qty: 114, pnl: +0.13%})           â”‚
â”‚  [ 8] TechnicalDataComponent({rsi: 52, trend: bullish})        â”‚
â”‚  [ 6] TaskInstructionComponent('POSITION_REVIEW')               â”‚
â”‚  [ 1] ResponseFormatComponent('STANDARD_DECISION')              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ASSEMBLED PROMPT                                 â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’¼ QUERY TYPE: POSITION REVIEW                                 â”‚
â”‚  ğŸ”” TRIGGER: Capital Constraint ($592 available)                â”‚
â”‚  ğŸ¯ PROFILE: Active Rotator                                     â”‚
â”‚      â€¢ Lower bar for SELL (40% confidence)                      â”‚
â”‚      â€¢ Prioritize rotation over holding                         â”‚
â”‚                                                                  â”‚
â”‚  ğŸ’¼ POSITION DETAILS: AAPL                                      â”‚
â”‚      YOU ALREADY OWN: 114 shares @ $263.46                      â”‚
â”‚      Current: $263.81, P&L: +0.13%                             â”‚
â”‚      Status: SMALL PROFIT (evaluate rotation opportunity)       â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š TECHNICAL DATA: AAPL                                        â”‚
â”‚      Price: $263.81, Bullish trend                             â”‚
â”‚      RSI: 52 (neutral)                                         â”‚
â”‚                                                                  â”‚
â”‚  âš¡ TASK: Should you HOLD or SELL this position?               â”‚
â”‚      Compare against other opportunities                        â”‚
â”‚      Small profits are still profits - rotate if better exists  â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“‹ RESPONSE FORMAT: {action, confidence, reasoning...}         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LLM (Gemma 3)                              â”‚
â”‚  "Processing context-aware prompt..."                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LLM RESPONSE                                  â”‚
â”‚  {                                                              â”‚
â”‚    "sentiment": "neutral",                                      â”‚
â”‚    "confidence": 55,                                            â”‚
â”‚    "action": "sell",                                            â”‚
â”‚    "reasoning": "Position flat (+0.13%), RSI neutral. With     â”‚
â”‚                  capital constrained, rotate to better          â”‚
â”‚                  opportunities. NVDA showing stronger setup.",  â”‚
â”‚    "risk_factors": [...]                                        â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RESPONSE HANDLER                                   â”‚
â”‚  StandardDecisionHandler validates and parses JSON              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 TRADING DECISION                                â”‚
â”‚  action='sell', confidence=55, reasoning='...'                  â”‚
â”‚  â†’ Execute SELL for AAPL                                        â”‚
â”‚  â†’ Free $30,000+ capital for better opportunities               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Comparison: Old vs New System

### OLD SYSTEM (Current)

```
Trading Agent
    â”‚
    â”œâ”€ analyze_symbol('AAPL')
    â”‚       â”‚
    â”‚       â””â”€ create_analysis_prompt()  â† SINGLE FUNCTION
    â”‚               â”‚
    â”‚               â””â”€ Hardcoded prompt with all sections
    â”‚                   "You are aggressive trader..." (SYSTEM PROMPT)
    â”‚                   "Recommend BUY on ANY bullish signal"
    â”‚                   Technical data
    â”‚                   Position data (maybe)
    â”‚                   Task: "Should I trade this?"
    â”‚                       â”‚
    â”‚                       â–¼
    â”‚                   PROBLEM: Same prompt whether:
    â”‚                   - New opportunity (should say BUY)
    â”‚                   - Existing position (should consider SELL)
    â”‚                   - Portfolio audit (need ranking)
    â”‚
    â””â”€ LLM Response: "BUY" (even for existing positions!)
```

### NEW SYSTEM (Modular)

```
Trading Agent
    â”‚
    â”œâ”€ For new stock: query_type='NEW_OPPORTUNITY'
    â”‚       â”‚
    â”‚       â””â”€ Prompt emphasizes: "Should I BUY?"
    â”‚           Components: QueryType + Technical + Task(BUY focus)
    â”‚               â”‚
    â”‚               â””â”€ LLM Response: "BUY" âœ… Correct!
    â”‚
    â”œâ”€ For existing position: query_type='POSITION_REVIEW'
    â”‚       â”‚
    â”‚       â””â”€ Prompt emphasizes: "Should I SELL or HOLD?"
    â”‚           Components: QueryType + Position + Technical + Task(SELL focus)
    â”‚               â”‚
    â”‚               â””â”€ LLM Response: "SELL" or "HOLD" âœ… Context-aware!
    â”‚
    â””â”€ For portfolio: query_type='PORTFOLIO_AUDIT'
            â”‚
            â””â”€ Prompt emphasizes: "Rank all holdings"
                Components: QueryType + Portfolio + Comparative + Task(Ranking)
                    â”‚
                    â””â”€ LLM Response: Ranked list âœ… Right format!
```

---

## ğŸ¯ Component Interaction Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     QUERY CONTEXT                               â”‚
â”‚  (Defines WHAT we want to know)                                 â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Query Type    â”‚  â”‚    Trigger     â”‚  â”‚    Profile     â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚  â”‚ NEW_OPP        â”‚  â”‚ SCHEDULED      â”‚  â”‚ conservative   â”‚   â”‚
â”‚  â”‚ POS_REVIEW     â”‚  â”‚ CAPITAL_LOW    â”‚  â”‚ moderate       â”‚   â”‚
â”‚  â”‚ PORTFOLIO      â”‚  â”‚ PRICE_ALERT    â”‚  â”‚ aggressive     â”‚   â”‚
â”‚  â”‚ COMPARISON     â”‚  â”‚ NEWS_EVENT     â”‚  â”‚ rotator        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  COMPONENT REGISTRY                             â”‚
â”‚  (Available building blocks)                                    â”‚
â”‚                                                                  â”‚
â”‚  CONTEXT          DATA              INSTRUCTIONS                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚
â”‚  QueryType        Technical         Task                        â”‚
â”‚  Trigger          Position          Format                      â”‚
â”‚  Profile          Portfolio         Examples                    â”‚
â”‚                   News                                          â”‚
â”‚                   MarketRegime                                  â”‚
â”‚                   Comparative                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SELECTION LOGIC                                â”‚
â”‚  (PromptBuilder decides which components to use)                â”‚
â”‚                                                                  â”‚
â”‚  IF query_type == 'NEW_OPPORTUNITY':                            â”‚
â”‚      Use: QueryType + Profile + Technical + Task + Format       â”‚
â”‚                                                                  â”‚
â”‚  IF query_type == 'POSITION_REVIEW':                            â”‚
â”‚      Use: QueryType + Profile + Position + Technical +          â”‚
â”‚           Task(SELL-focused) + Format                           â”‚
â”‚                                                                  â”‚
â”‚  IF query_type == 'PORTFOLIO_AUDIT':                            â”‚
â”‚      Use: QueryType + Profile + Portfolio + Comparative +       â”‚
â”‚           Task(Ranking) + Format(Ranking)                       â”‚
â”‚                                                                  â”‚
â”‚  IF include_news == True:                                       â”‚
â”‚      Add: News component                                        â”‚
â”‚                                                                  â”‚
â”‚  IF include_market_regime == True:                              â”‚
â”‚      Add: MarketRegime component                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ASSEMBLY & RENDERING                            â”‚
â”‚                                                                  â”‚
â”‚  1. Sort components by priority (10 â†’ 1)                        â”‚
â”‚  2. Render each component.render()                              â”‚
â”‚  3. Join sections with "\n\n"                                   â”‚
â”‚  4. Return complete prompt string                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Flow: Real-World Scenario

### Scenario: Capital Constrained Portfolio Review

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TIME: 10:45 AM - Trading Cycle Starts                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Agent checks account state                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚  Portfolio: $100,547                                            â”‚
â”‚  Buying Power: $592 (0.59%) â† CRITICAL!                        â”‚
â”‚  Positions: 10                                                  â”‚
â”‚                                                                  â”‚
â”‚  Decision: buying_power < 5% of portfolio                       â”‚
â”‚  â†’ Trigger PORTFOLIO_AUDIT                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Build Query Context                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚  context = QueryContext(                                        â”‚
â”‚      query_type = 'PORTFOLIO_AUDIT',                            â”‚
â”‚      trigger = 'CAPITAL_CONSTRAINT',                            â”‚
â”‚      profile = 'rotator',                                       â”‚
â”‚      portfolio_state = {                                        â”‚
â”‚          'buying_power': 592,                                   â”‚
â”‚          'total_value': 100547,                                 â”‚
â”‚          'positions': [...]  # All 10 positions                 â”‚
â”‚      },                                                         â”‚
â”‚      expected_format = 'RANKING'                                â”‚
â”‚  )                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: PromptBuilder assembles components                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚  Selected Components:                                           â”‚
â”‚  â”œâ”€ QueryTypeComponent('PORTFOLIO_AUDIT')                       â”‚
â”‚  â”‚   â†’ "ğŸ“Š QUERY TYPE: PORTFOLIO AUDIT"                        â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€ TriggerComponent('CAPITAL_CONSTRAINT')                      â”‚
â”‚  â”‚   â†’ "ğŸ”” TRIGGER: Need to free capital ($592 available)"     â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€ TradingProfileComponent('rotator')                          â”‚
â”‚  â”‚   â†’ "ğŸ¯ PROFILE: Active Capital Rotator"                    â”‚
â”‚  â”‚      "Lower bar for SELL (40% confidence)"                  â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€ PortfolioSummaryComponent({...})                            â”‚
â”‚  â”‚   â†’ "ğŸ’¼ PORTFOLIO STATE:"                                   â”‚
â”‚  â”‚      "10 positions, $592 buying power (0.59%)"              â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€ ComparativeDataComponent([AAPL, MSFT, ...])                â”‚
â”‚  â”‚   â†’ "AAPL: RSI 52, Bullish, P&L +0.13%"                    â”‚
â”‚  â”‚      "MSFT: RSI 54, Bullish, P&L +0.38%"                   â”‚
â”‚  â”‚      "TSLA: RSI 48, Neutral, P&L -1.2%"                     â”‚
â”‚  â”‚      ... (all 10 positions)                                 â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€ TaskInstructionComponent('PORTFOLIO_AUDIT')                 â”‚
â”‚  â”‚   â†’ "âš¡ TASK: Rank all holdings from STRONGEST to WEAKEST"  â”‚
â”‚  â”‚      "Identify bottom 3 to SELL for capital rotation"       â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€ ResponseFormatComponent('RANKING')                          â”‚
â”‚      â†’ "ğŸ“‹ RESPONSE FORMAT:"                                   â”‚
â”‚         "{ ranked_positions: [...], summary: '...' }"          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: LLM analyzes and responds                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚  {                                                              â”‚
â”‚    "ranked_positions": [                                        â”‚
â”‚      {                                                          â”‚
â”‚        "symbol": "NVDA",                                        â”‚
â”‚        "rank": 1,                                               â”‚
â”‚        "score": 92,                                             â”‚
â”‚        "action": "keep",                                        â”‚
â”‚        "reason": "Strongest momentum, RSI healthy, leading     â”‚
â”‚                   tech sector"                                  â”‚
â”‚      },                                                         â”‚
â”‚      {                                                          â”‚
â”‚        "symbol": "MSFT",                                        â”‚
â”‚        "rank": 2,                                               â”‚
â”‚        "score": 88,                                             â”‚
â”‚        "action": "keep",                                        â”‚
â”‚        "reason": "Solid uptrend, best P&L, reliable"           â”‚
â”‚      },                                                         â”‚
â”‚      ...                                                        â”‚
â”‚      {                                                          â”‚
â”‚        "symbol": "AAPL",                                        â”‚
â”‚        "rank": 8,                                               â”‚
â”‚        "score": 52,                                             â”‚
â”‚        "action": "sell",                                        â”‚
â”‚        "reason": "Flat P&L (+0.13%), neutral momentum,         â”‚
â”‚                   better opportunities exist"                   â”‚
â”‚      },                                                         â”‚
â”‚      {                                                          â”‚
â”‚        "symbol": "TSLA",                                        â”‚
â”‚        "rank": 9,                                               â”‚
â”‚        "score": 45,                                             â”‚
â”‚        "action": "sell",                                        â”‚
â”‚        "reason": "Losing position (-1.2%), weak technicals"    â”‚
â”‚      },                                                         â”‚
â”‚      {                                                          â”‚
â”‚        "symbol": "INTC",                                        â”‚
â”‚        "rank": 10,                                              â”‚
â”‚        "score": 38,                                             â”‚
â”‚        "action": "sell",                                        â”‚
â”‚        "reason": "Worst holding, broken trend, cut losses"     â”‚
â”‚      }                                                          â”‚
â”‚    ],                                                           â”‚
â”‚    "summary": "Portfolio has 4 strong positions (keep), 3      â”‚
â”‚                neutral (monitor), 3 weak (sell). Rotating      â”‚
â”‚                ~$60K capital will free funds for better         â”‚
â”‚                opportunities."                                  â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: Execute SELL decisions                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  For each position where action == 'sell':                      â”‚
â”‚      â”œâ”€ SELL AAPL: 114 shares â†’ Free $30,000                   â”‚
â”‚      â”œâ”€ SELL TSLA: 85 shares â†’ Free $20,000                    â”‚
â”‚      â””â”€ SELL INTC: 200 shares â†’ Free $10,000                   â”‚
â”‚                                                                  â”‚
â”‚  Result:                                                        â”‚
â”‚      Buying Power: $592 â†’ $60,592 âœ…                           â”‚
â”‚      Can now buy 100+ shares of strong opportunities           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Component Reusability Matrix

Shows which components are used for which query types:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component          â”‚ NEW â”‚ POS â”‚ PORT   â”‚ COMP   â”‚ MARKET â”‚
â”‚                    â”‚ OPP â”‚ REV â”‚ AUDIT  â”‚ ANAL   â”‚ REGIME â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ QueryType          â”‚  âœ“  â”‚  âœ“  â”‚   âœ“    â”‚   âœ“    â”‚   âœ“    â”‚
â”‚ Trigger            â”‚  âœ“  â”‚  âœ“  â”‚   âœ“    â”‚   âœ“    â”‚   âœ“    â”‚
â”‚ TradingProfile     â”‚  âœ“  â”‚  âœ“  â”‚   âœ“    â”‚   âœ“    â”‚   âœ“    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TechnicalData      â”‚  âœ“  â”‚  âœ“  â”‚   âœ“    â”‚   âœ“    â”‚        â”‚
â”‚ PositionData       â”‚     â”‚  âœ“  â”‚        â”‚        â”‚        â”‚
â”‚ PortfolioSummary   â”‚     â”‚     â”‚   âœ“    â”‚        â”‚        â”‚
â”‚ ComparativeData    â”‚     â”‚     â”‚   âœ“    â”‚   âœ“    â”‚        â”‚
â”‚ News               â”‚  âœ“  â”‚  âœ“  â”‚        â”‚   âœ“    â”‚        â”‚
â”‚ MarketRegime       â”‚     â”‚     â”‚   âœ“    â”‚        â”‚   âœ“    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TaskInstruction    â”‚  âœ“  â”‚  âœ“  â”‚   âœ“    â”‚   âœ“    â”‚   âœ“    â”‚
â”‚ ResponseFormat     â”‚  âœ“  â”‚  âœ“  â”‚   âœ“    â”‚   âœ“    â”‚   âœ“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
  NEW OPP = NEW_OPPORTUNITY
  POS REV = POSITION_REVIEW
  PORT AUDIT = PORTFOLIO_AUDIT
  COMP ANAL = COMPARATIVE_ANALYSIS
  MARKET REGIME = MARKET_REGIME
```

**Key Insight**: 
- 3 components used by ALL queries (QueryType, Trigger, Profile)
- Data components are query-specific
- Instructions components are always used but content varies

---

## ğŸ’¡ Example Prompt Variations

### Same Stock (NVDA), 3 Different Contexts

#### Context 1: NEW_OPPORTUNITY
```
ğŸ¯ NEW OPPORTUNITY: NVDA
ğŸ¯ PROFILE: Aggressive (act fast, accept risk)
ğŸ“Š TECHNICAL: $850, Bullish, RSI 62
âš¡ TASK: Should I BUY this new stock?

RESULT â†’ "BUY" (85% confidence)
```

#### Context 2: POSITION_REVIEW
```
ğŸ’¼ POSITION REVIEW: NVDA
ğŸ¯ PROFILE: Rotator (continuous rotation)
ğŸ’¼ POSITION: Own 50 shares @ $800, P&L +6.25%
ğŸ“Š TECHNICAL: $850, Bullish, RSI 62
âš¡ TASK: Should I SELL to take profits or HOLD?

RESULT â†’ "HOLD" (70% confidence) "Let winner run, still strong"
```

#### Context 3: PORTFOLIO_AUDIT
```
ğŸ“Š PORTFOLIO AUDIT
ğŸ¯ PROFILE: Rotator
ğŸ’¼ 10 positions compared:
   NVDA: Rank 1/10, Score 92, Action: KEEP
   AAPL: Rank 8/10, Score 52, Action: SELL
   ...

RESULT â†’ Ranking with NVDA as top holding
```

---

**This visual guide shows how the same components combine in different ways to create context-aware, intelligent prompts! ğŸ¨**
